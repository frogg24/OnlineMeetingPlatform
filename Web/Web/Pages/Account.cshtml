@page
@model Web.Pages.AccountModel
@{
    ViewData["Title"] = "Личный кабинет";
}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - Платформа мероприятий</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
    @{
        await Html.RenderPartialAsync("Header");
    }

    <main class="main-content">
        <div class="container">
            @if (!string.IsNullOrEmpty(Model.StatusMessage))
            {
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    @Model.StatusMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            @{
                                var username = HttpContext.Request.Cookies["Username"];
                                var userEmail = HttpContext.Request.Cookies["UserEmail"];
                                var displayName = !string.IsNullOrEmpty(username)
                                ? username
                                : !string.IsNullOrEmpty(userEmail)
                                ? userEmail
                                : "Пользователь";
                                var firstLetter = displayName[0].ToString().ToUpper();
                            }

                            <div class="me-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                     style="width: 56px; height: 56px; font-size: 24px;">
                                    @firstLetter
                                </div>
                            </div>

                            <div>
                                <h1 class="welcome-title mb-2">
                                    Добро пожаловать, <span class="username-highlight">@displayName</span>!
                                </h1>
                                <p class="welcome-subtitle">Это ваш личный кабинет на платформе мероприятий</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 text-md-end">
                        <div class="notification-widget d-inline-flex align-items-center gap-2 p-2 rounded-pill bg-opacity-15 border border-white border-opacity-25">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="notificationToggle" checked>
                                <label class="form-check-label small fw-medium" for="notificationToggle">
                                    <i data-feather="bell" class="feather-icon me-1" style="width: 16px; height: 16px;"></i>
                                    Уведомления
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Раздел участника -->
            <div class="section-card card mb-5">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i data-feather="users" class="me-2"></i>
                        Раздел участника
                    </h3>
                </div>
                <div class="card-body">
                    @if (Model.ParticipantMeetings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Название мероприятия</th>
                                        <th>Дата</th>
                                        <th>Ссылка</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var meeting in Model.ParticipantMeetings)
                                    {
                                        var participation = Model.UserMeetingParticipations.FirstOrDefault(mu => mu.MeetingId == meeting.Id);
                                        <tr>
                                            <td>@meeting.Title</td>
                                            <td>@meeting.Date.ToString("dd.MM.yyyy")</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(meeting.Link))
                                                {
                                                    <a href="@meeting.Link" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">
                                                        @meeting.Link
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span >Не указана</span>
                                                }
                                            </td>
                                            <td>
                                                @if (participation != null)
                                                {
                                                    <button class="btn btn-outline-danger btn-sm" onclick="leaveEvent(@participation.Id, '@meeting.Title')">
                                                        <i data-feather="x" width="16" height="16"></i> Отказаться
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i data-feather="calendar" width="48" height="48" mb-3"></i>
                            <h5>Вы не участвуете ни в каких мероприятиях</h5>
                            <p>Найдите интересные мероприятия и присоединяйтесь к ним!</p>
                            <a href="/Events" class="btn btn-primary">Найти мероприятия</a>
                        </div>
                    }
                </div>
            </div>

            <!-- Раздел организатора -->
            <div class="section-card card mb-5">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i data-feather="calendar-plus" class="me-2"></i>
                        Раздел организатора
                    </h3>
                </div>
                <div class="card-body">

                    @if (Model.UserMeetings.Any())
                    {
                        <div class="mb-3">
                            <a href="/CreateMeeting" class="btn btn-success">
                                <i data-feather="plus" class="me-1"></i>
                                Создать мероприятие
                            </a>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Название мероприятия</th>
                                        <th>Дата</th>
                                        <th>Описание</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var meeting in Model.UserMeetings)
                                    {
                                        <tr>
                                            <td>@meeting.Title</td>
                                            <td>@meeting.Date.ToString("dd.MM.yyyy")</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(meeting.Description))
                                                {
                                                    <div class="text-truncate" style="max-width: 250px;"
                                                         title="@meeting.Description">
                                                        @meeting.Description
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span>Без описания</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="/EditMeeting/@meeting.Id" class="btn btn-outline-primary btn-sm">
                                                        <i data-feather="edit" width="14" height="14"></i>
                                                    </a>
                                                    <a href="/ViewMeeting/@meeting.Id" class="btn btn-outline-info btn-sm">
                                                        <i data-feather="eye" width="14" height="14"></i>
                                                    </a>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteEvent(@meeting.Id, '@meeting.Title')">
                                                        <i data-feather="trash-2" width="14" height="14"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i data-feather="calendar-plus" width="48" height="48" mb-3"></i>
                            <h5>Вы не создавали мероприятий</h5>
                            <p>Создайте свое первое мероприятие и начните принимать участников!</p>
                            <a href="/CreateMeeting" class="btn btn-success">
                                <i data-feather="plus" class="me-1"></i>
                                Создать мероприятие
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>

    <!-- Модальное окно подтверждения -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подтверждение действия</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Инициализация Feather Icons
        feather.replace();

        // Переключение уведомлений
        document.getElementById('notificationToggle').addEventListener('change', function() {
            const isChecked = this.checked;
            // Здесь можно добавить AJAX-запрос для сохранения предпочтений
            console.log('Уведомления:', isChecked ? 'включены' : 'выключены');
        });

        let currentEventId = null;
        let actionType = '';

        // Функция для отказа от участия в мероприятии
        function leaveEvent(meetingUserId, eventTitle) {
            currentEventId = meetingUserId;
            actionType = 'leave';
            document.getElementById('modalMessage').textContent =
                `Вы уверены, что хотите отказаться от участия в мероприятии "${eventTitle}"?`;
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        // Функция для удаления мероприятия
        function deleteEvent(eventId, eventTitle) {
            currentEventId = eventId;
            actionType = 'delete';
            document.getElementById('modalMessage').textContent =
                `Вы уверены, что хотите удалить мероприятие "${eventTitle}"? Это действие необратимо.`;
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        // Обработчик подтверждения действия
        document.getElementById('confirmAction').addEventListener('click', async function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));

            try {
                let url = '';
                let method = 'DELETE';
                let successMessage = '';

                if (actionType === 'leave') {
                    // Отказ от участия - используем MeetingUser Id
                    url = `/api/meeting/removeuser/${currentEventId}`;
                    successMessage = 'Вы отказались от участия в мероприятии';
                } else if (actionType === 'delete') {
                    // Удаление мероприятия
                    url = `/api/meeting/delete/${currentEventId}`;
                    successMessage = 'Мероприятие успешно удалено';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || successMessage);
                    location.reload();
                } else {
                    const error = await response.text();
                    alert(`Ошибка: ${error}`);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при выполнении операции');
            } finally {
                modal.hide();
                currentEventId = null;
                actionType = '';
            }
        });
    </script>
</body>
</html>